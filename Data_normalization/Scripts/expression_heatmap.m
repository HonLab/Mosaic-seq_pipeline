clear;

%set data directory
data_dir     = '/project/GCRB/Hon_lab/s160875/DropKICK-seq/2016-10-21_combined_analysis/Normalized_data';
data_set_id  = {'Batch_A.rep2'};
%set colormap
mycolormap = [1.0000    1.0000    1.0000
              1.0000    0.9841    0.9841
              1.0000    0.9683    0.9683
              1.0000    0.9524    0.9524
              1.0000    0.9365    0.9365
              1.0000    0.9206    0.9206
              1.0000    0.9048    0.9048
              1.0000    0.8889    0.8889
              1.0000    0.8730    0.8730
              1.0000    0.8571    0.8571
              1.0000    0.8413    0.8413
              1.0000    0.8254    0.8254
              1.0000    0.8095    0.8095
              1.0000    0.7937    0.7937
              1.0000    0.7778    0.7778
              1.0000    0.7619    0.7619
              1.0000    0.7460    0.7460
              1.0000    0.7302    0.7302
              1.0000    0.7143    0.7143
              1.0000    0.6984    0.6984
              1.0000    0.6825    0.6825
              1.0000    0.6667    0.6667
              1.0000    0.6508    0.6508
              1.0000    0.6349    0.6349
              1.0000    0.6190    0.6190
              1.0000    0.6032    0.6032
              1.0000    0.5873    0.5873
              1.0000    0.5714    0.5714
              1.0000    0.5556    0.5556
              1.0000    0.5397    0.5397
              1.0000    0.5238    0.5238
              1.0000    0.5079    0.5079
              1.0000    0.4921    0.4921
              1.0000    0.4762    0.4762
              1.0000    0.4603    0.4603
              1.0000    0.4444    0.4444
              1.0000    0.4286    0.4286
              1.0000    0.4127    0.4127
              1.0000    0.3968    0.3968
              1.0000    0.3810    0.3810
              1.0000    0.3651    0.3651
              1.0000    0.3492    0.3492
              1.0000    0.3333    0.3333
              1.0000    0.3175    0.3175
              1.0000    0.3016    0.3016
              1.0000    0.2857    0.2857
              1.0000    0.2698    0.2698
              1.0000    0.2540    0.2540
              1.0000    0.2381    0.2381
              1.0000    0.2222    0.2222
              1.0000    0.2063    0.2063
              1.0000    0.1905    0.1905
              1.0000    0.1746    0.1746
              1.0000    0.1587    0.1587
              1.0000    0.1429    0.1429
              1.0000    0.1270    0.1270
              1.0000    0.1111    0.1111
              1.0000    0.0952    0.0952
              1.0000    0.0794    0.0794
              1.0000    0.0635    0.0635
              1.0000    0.0476    0.0476
              1.0000    0.0317    0.0317
              1.0000    0.0159    0.0159
              1.0000         0         0];

%set the region
region_id = {'PIM1.SE2.HS2',...
             'PIM1.promoter',...
             'PIM1.SE1.HS1',...
             'PIM1.SE1.HS10',...
             'PIM1.SE1.HS2',...
             'PIM1.SE1.HS3',...
             'PIM1.SE1.HS6',...
             'PIM1.SE1.HS7',...
             'PIM1.SE1.HS8',...
             'PIM1.SE1.HS9',...
             'PIM1.SE2.HS1',...
             'PIM1.SE2.HS10',...
             'PIM1.SE2.HS11',...
             'PIM1.SE2.HS12',...
             'PIM1.SE2.HS3',...
             'PIM1.SE2.HS4',...
             'PIM1.SE2.HS5',...
             'PIM1.SE2.HS6',...
             'PIM1.SE2.HS9',...
             'CD52.promoter',...
             'CD52.SE1.HS1',...
             'CD52.SE1.HS2',...
             'CD52.SE1.HS3',...
             'CD52.SE2.HS2',...
             'CD52.SE2.HS3',...
             'CD52.SE2.HS4',...
             'CD52.SE2.HS5',...
             'CD52.SE2.HS6',...
             'CD52.SE3.HS1',...
             'CD52.SE3.HS2',...
             'CD52.SE3.HS4',...
             'CD52.SE3.HS5',...
             'CD52.SE3.HS6',...
             'beta_globin.HBE1_positive_control',...
             'beta_globin.HBE1.promoter',...
             'beta_globin.HS2_positive_control',...
             'beta_globin.SE1.HS1',...
             'beta_globin.SE1.HS2',...
             'beta_globin.SE1.HS3',...
             'beta_globin.SE1.HS4',...
             'SMYD3.promoter',...
             'SMYD3.SE2.HS10',...
             'SMYD3.SE2.HS11',...
             'SMYD3.SE2.HS12',...
             'SMYD3.SE2.HS1',...
             'SMYD3.SE2.HS2',...
             'SMYD3.SE2.HS3',...
             'SMYD3.SE2.HS4',...
             'SMYD3.SE2.HS6',...
             'SMYD3.SE2.HS7',...
             'SMYD3.SE2.HS8',...
             'SMYD3.SE3.HS1',...
             'SMYD3.SE3.HS3',...
             'SMYD3.SE3.HS4',...
             'SMYD3.SE3.HS5',...
             'SMYD3.SE3.HS6',...
             'SMYD3.SE3.HS7',...
             'FADS1.promoter',...
             'FADS1.SE1.HS1',...
             'FADS1.SE2.HS1',...
             'FADS1.SE2.HS2',...
             'FADS1.SE3.HS3',...
             'FADS1.SE3.HS3',...
             'FADS1.SE3.HS4',...
             'FADS1.SE4.HS1',...
             'FADS1.SE4.HS2',...
             'FADS1.SE4.HS3',... 
             'PRKAR2B.promoter',...
             'PRKAR2B.SE1.HS1',...
             'PRKAR2B.SE1.HS2',...
             'PRKAR2B.SE1.HS3',...
             'PRKAR2B.SE2.HS1',...
             'PRKAR2B.SE2.HS2',...
             'PRKAR2B.SE3.HS1',...
             'PRKAR2B.SE3.HS2',...
             'PRKAR2B.SE3.HS4',...
             'PRKAR2B.SE3.HS5',...
             'PRKAR2B.SE3.HS8',...
             'UFD1L.promoter',...
             'UFD1L.SE1.HS1',...
             'UFD1L.SE1.HS4',...
             'Control'};


sgRNA_cell_index = [];
for i = 1:length(data_set_id)
  %load the cell barcode file for all the cells
  cell_bc_file_name     = sprintf('%s/combined.%s/all_sgRNA.uniq.cell_barcodes',data_dir,data_set_id{i});
  cell_bc_file          = fopen(cell_bc_file_name, 'r');
  cell_bc_array         = textscan (cell_bc_file, '%s', 'Delimiter','\n');
  cell_barcode          = cell_bc_array{1};

  %load the data
  matrix = load (sprintf('%s/combined.%s/normalized.all.matrix.txt.no_header',data_dir,data_set_id{i}));
  %perm_order = randperm(size(matrix,2));
  perm_order = 1:size(matrix,2);
  matrix_perm = matrix(:, perm_order);
  cell_barcode_perm = cell_barcode(perm_order);

  for j = 1:length(region_id)
    %scan the folder to get the file list
    search_string = sprintf('%s/combined.%s/%s.*.cell_barcodes',data_dir,data_set_id{i},region_id{j});
    sgRNA_files = dir(search_string);
    for sgRNA_file = sgRNA_files'
      %load the cell barcode file for each sgRNA
      fprintf('region = %s, dataset = %s, sgRNA = %s\n', region_id{j}, data_set_id{i}, sgRNA_file.name);
      full_name             = sprintf('%s/combined.%s/%s',data_dir,data_set_id{i},sgRNA_file.name);
      sgRNA_pos_file        = fopen(full_name,'r');
      sgRNA_pos_cell_array  = textscan (sgRNA_pos_file, '%s', 'Delimiter','\n');
      sgRNA_pos_barcode     = sgRNA_pos_cell_array{1};
      current_sgRNA_index   = get_cell_barcode_index(cell_barcode_perm, sgRNA_pos_barcode);
    
      sgRNA_cell_index = [sgRNA_cell_index current_sgRNA_index];
    end
  end

  
  %get the total counts of every gene
  counts_gene        = median(matrix_perm,2);
  filter_index       = find(counts_gene > 0);
  filter_counts_gene = counts_gene(filter_index);
  
  filter_matrix = matrix_perm(filter_index,:);
  
  [sorted_counts_gene, index_gene] = sort (filter_counts_gene, 'descend');

  imagesc(filter_matrix(index_gene, sgRNA_cell_index));
  colormap (mycolormap);
end

%final_matrix = filter_matrix(index_gene, :);
%figure(2)
%imagesc(final_matrix(743:753, 1:38))
%colormap (mycolormap);
